import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const canonicalPath = path.join(root, 'canonical', 'theme.json');
const inputDir = path.join(root, 'input');
const buildDir = path.join(root, 'build', 'salla');

function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function copyFileSafe(src, dest) {
  ensureDir(path.dirname(dest));
  fs.copyFileSync(src, dest);
}

function writeIfMissing(file, content) {
  if (!fs.existsSync(file)) {
    ensureDir(path.dirname(file));
    fs.writeFileSync(file, content, 'utf8');
  }
}

function main() {
  if (!fs.existsSync(canonicalPath)) {
    console.error('Canonical model not found. Run "npm run canonicalize" first.');
    process.exit(1);
  }
  const model = JSON.parse(fs.readFileSync(canonicalPath, 'utf8'));

  // Copy referenced images from input to build assets
  const images = model?.assets?.images || [];
  const copied = [];
  for (const rel of images) {
    const src = path.isAbsolute(rel) ? rel : path.join(inputDir, rel);
    if (fs.existsSync(src)) {
      const dest = path.join(buildDir, 'assets', 'images', path.basename(rel));
      copyFileSafe(src, dest);
      copied.push(dest);
    }
  }

  // Copy any additional assets from input/assets/**/* into build/salla/assets/**/*
  const inputAssetsDir = path.join(inputDir, 'assets');
  let extraCount = 0;
  if (fs.existsSync(inputAssetsDir)) {
    const walk = (dir, relBase = '') => {
      for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
        const rel = path.join(relBase, entry.name);
        const src = path.join(dir, entry.name);
        const dest = path.join(buildDir, 'assets', rel);
        if (entry.isDirectory()) walk(src, rel);
        else {
          copyFileSafe(src, dest);
          extraCount++;
        }
      }
    };
    walk(inputAssetsDir);
  }

  // Ensure default styles and scripts exist
  writeIfMissing(
    path.join(buildDir, 'assets', 'styles', 'app.css'),
    `/* Generated by Beto Factory */\n:root{--brand:#11224E} body{font-family:system-ui}\n`
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'app.js'),
    `// Generated by Beto Factory\nconsole.log('Beto Theme assets loaded');\n`
  );
  // API integration layer (client + helpers)
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'salla-api-client.js'),
    `// Generated Salla API client (simplified)\nexport class SallaAPI {\n  constructor(storeIdentifier, currency = 'SAR') {\n    this.baseURL = 'https://api.salla.dev/store/v1';\n    this.headers = {\n      'Store-Identifier': storeIdentifier || '',\n      'Currency': currency,\n      'Accept-Language': 'ar',\n      's-app-version': '1.0.0',\n      's-source': 'theme'\n    };\n  }\n  async _json(url, init = {}) {\n    const res = await fetch(url, init);\n    if (!res.ok) throw new Error('API error ' + res.status);\n    return res.json();\n  }\n  async addToCart(cartId, productId, quantity = 1, options = []) {\n    return this._json(\`${'${'}this.baseURL{'}'}/cart/\${'${'}cartId{'}'}/item/\${'${'}productId{'}'}/add\`, {\n      method: 'POST',\n      headers: { ...this.headers, 'Content-Type': 'application/json' },\n      body: JSON.stringify({ quantity, options })\n    });\n  }\n  async getProductDetails(productId) {\n    return this._json(\`${'${'}this.baseURL{'}'}/products/\${'${'}productId{'}'}/details?with=skus_availability\`, { headers: this.headers });\n  }\n  async getCart(cartId) {\n    return this._json(\`${'${'}this.baseURL{'}'}/cart/\${'${'}cartId{'}'}\`, { headers: this.headers });\n  }\n}\nif (typeof window !== 'undefined') { window.SallaAPI = SallaAPI; }\n`
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'cart-manager.js'),
    `// Generated cart manager\nimport { SallaAPI } from './salla-api-client.js';\nconst api = new SallaAPI(window.STORE_IDENTIFIER || '', window.CURRENCY || 'SAR');\nexport async function getOrCreateCartId() {\n  let id = localStorage.getItem('cart_id');\n  if (!id) {\n    const tmp = await api._json(\`${'${'}api.baseURL{'}'}/cart\`, { method: 'POST', headers: api.headers });\n    id = tmp.data?.id || tmp.id || '';\n    if (id) localStorage.setItem('cart_id', id);\n  }\n  return id;\n}\nexport async function updateCartCounter(count) {\n  const el = document.getElementById('cart-count');\n  if (el) el.textContent = count + ' items';\n}\nif (typeof window !== 'undefined') { window.getOrCreateCartId = getOrCreateCartId; window.updateCartCounter = updateCartCounter; window.sallaAPI = api; }\n`
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'product-filter.js'),
    `// Generated product filter (skeleton)\nexport class ProductFilterSystem {\n  constructor() {\n    this.filters = { category: [], brand: [], price: { min: 0, max: 1000 }, sort: 'latest' };\n  }\n  async applyFilters() {\n    const params = new URLSearchParams();\n    if (this.filters.category?.length) { params.append('source', 'categories'); this.filters.category.forEach((id)=>params.append('source_value[]', id)); }\n    if (this.filters.brand?.length) { params.append('source', 'brands'); this.filters.brand.forEach((id)=>params.append('source_value[]', id)); }\n    const res = await fetch('/store/v1/products?' + params.toString());\n    const data = await res.json();\n    return data;\n  }\n}\nif (typeof window !== 'undefined') { window.ProductFilterSystem = ProductFilterSystem; }\n`
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'quick-buy.js'),
    `// Generated quick-buy integration\nimport { getOrCreateCartId, updateCartCounter } from './cart-manager.js';\nimport { SallaAPI } from './salla-api-client.js';\nconst api = new SallaAPI(window.STORE_IDENTIFIER || '', window.CURRENCY || 'SAR');\ndocument.addEventListener('click', async (e)=>{\n  const btn = e.target.closest('.quick-add-btn');\n  if (!btn) return;\n  const productId = btn.dataset.productId;\n  try {\n    const cartId = await getOrCreateCartId();\n    const result = await api.addToCart(cartId, productId);\n    const count = result?.data?.cart?.count || 0;\n    updateCartCounter(count);\n    btn.classList.add('added');\n    btn.textContent = 'Added!';\n  } catch(err) { console.error('Add to cart failed', err); }\n});\n`
  );

  // API endpoints config
  writeIfMissing(
    path.join(buildDir, 'config', 'api-endpoints.json'),
    JSON.stringify({
      products: '/store/v1/products',
      cart: '/store/v1/cart',
      categories: '/store/v1/categories',
      brands: '/store/v1/brands'
    }, null, 2)
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'js', 'product-interaction.js'),
    `// Generated by Beto Factory (interactive stubs)\n(function(){\n  if (typeof Salla !== 'undefined' && Salla.events && Salla.events.on) {\n    Salla.events.on('variant.selected', function(variant){\n      console.log('[Beto] variant selected', variant);\n    });\n  }\n  document.addEventListener('click', function(e){\n    const btn = e.target.closest('.quick-add-btn');\n    if (!btn) return;\n    const id = btn.getAttribute('data-product-id');\n    console.log('[Beto] quick add', id);\n    if (window.Salla && Salla.cart && Salla.cart.add) {\n      Salla.cart.add({id});\n    }\n  });\n})();\n`
  );
  writeIfMissing(
    path.join(buildDir, 'assets', 'styles', 'swatches.css'),
    `.variation-swatches{display:flex;gap:.5rem}.variation-swatches .swatch{padding:.4rem .6rem;border:1px solid #ccc;background:#fff;cursor:pointer}
`
  );

  console.log(`âœ… Assets prepared (${copied.length} images, +${extraCount} extra, css/js placeholders + api layer)`);
}

main();

